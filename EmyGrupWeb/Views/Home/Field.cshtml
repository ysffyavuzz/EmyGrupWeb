@{
    ViewData["Title"] = "Sahada Biz";
}
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

<section class="spacer-section">
    <div class="container py-5">

        <div class="text-center mb-5">
            <h2 class="field-title">
                @L["Side_Menu_SahadaBiz"]
            </h2>
            <div class="field-title-line"></div>
        </div>

        <!-- Masonry Galeri -->
        <div class="masonry-gallery" id="masonryGallery">
            @for (int i = 1; i <= 76; i++)
            {
                int imgIndex = i;

                // ✅ Sadece 21 ve 28 swap
                if (i == 21) imgIndex = 28;
                else if (i == 28) imgIndex = 21;

                <a href="/images/saha2/galeri/@(imgIndex).jpeg"
                   class="masonry-item"
                   data-index="@i"
                   aria-label="Saha Görseli @i">
                    <img src="/images/saha2/galeri/@(imgIndex).jpeg"
                         alt="Saha Görseli @i"
                         loading="lazy"
                         decoding="async" />
                </a>
            }
        </div>

    </div>
</section>

<!-- ✅ CUSTOM LIGHTBOX -->
<div class="saha-lightbox" id="sahaLightbox" aria-hidden="true">
    <button class="saha-lb-btn saha-lb-close" id="sahaLbClose" aria-label="Kapat"></button>

    <button class="saha-lb-btn saha-lb-prev" id="sahaLbPrev" aria-label="Önceki"></button>

    <div class="saha-lb-stage" id="sahaLbStage">
        <img id="sahaLbImg" alt="Büyük görsel" />
    </div>

    <button class="saha-lb-btn saha-lb-next" id="sahaLbNext" aria-label="Sonraki"></button>
</div>

<style>
    /* Navbar’dan aşağıda başlasın */
    .spacer-section {
        margin-top: 120px;
    }

    @@media (max-width: 768px) {
        .spacer-section {
            margin-top: 90px;
        }
    }

    /* Başlık tasarımı (+ ufak giriş animasyonu) */
    .field-title {
        font-size: 2.4rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 3px;
        font-family: 'Helvetica Neue', 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(180deg, #2b2b2b 0%, #000 100%);
        -webkit-background-clip: text;
        color: transparent;
        filter: drop-shadow(0 2px 5px rgba(0,0,0,0.15));
        margin-bottom: 14px;
        opacity: 0;
        transform: translateY(10px);
        animation: fieldTitleIn .65s ease forwards;
    }

    .field-title-line {
        width: 260px;
        height: 3px;
        margin: 0 auto;
        border-radius: 8px;
        background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0.55), rgba(0,0,0,0));
        opacity: 0.45;
        transform: scaleX(.85);
        opacity: 0;
        animation: fieldLineIn .75s ease forwards;
        animation-delay: .1s;
        transform-origin: center;
    }

    @@keyframes fieldTitleIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fieldLineIn {
        to {
            opacity: .45;
            transform: scaleX(1);
        }
    }

    /* ========================= */
    /*          MASONRY           */
    /* ========================= */
    .masonry-gallery {
        column-count: 4;
        column-gap: 18px;
        padding: 10px;
    }

    .masonry-item {
        display: block;
        break-inside: avoid;
        margin-bottom: 18px;
        border-radius: 16px;
        overflow: hidden;
        background: #fff;
        position: relative;
        /* Hover */
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        transition: transform .3s ease, box-shadow .3s ease, border-color .3s ease;
        /* Animasyon başlangıç durumu (ilk açılış + scroll) */
        opacity: 0;
        transform: translate3d(0, 14px, 0) scale(0.99);
        filter: blur(1.2px);
        will-change: transform, opacity, filter;
        border: 1px solid rgba(0,0,0,0.06);
        /* Gecikme JS’den gelecek */
        transition-delay: var(--d, 0ms);
    }

        /* Ekrana girince görünsün */
        .masonry-item.is-visible {
            opacity: 1;
            transform: translate3d(0, 0, 0) scale(1);
            filter: blur(0);
        }

        /* Resim yüklenmeden: skeleton (shimmer) maskesi */
        .masonry-item::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(240,240,240,0.95) 0%, rgba(250,250,250,0.98) 40%, rgba(240,240,240,0.95) 80% );
            background-size: 240% 100%;
            animation: shimmer 1.25s ease-in-out infinite;
            opacity: 1;
            transition: opacity .35s ease;
            pointer-events: none;
            z-index: 1;
        }

        /* Resim yüklendiyse skeleton’ı kaldır */
        .masonry-item.is-loaded::before {
            opacity: 0;
            animation: none;
        }

    @@keyframes shimmer {
        0% {
            background-position: 120% 0;
        }

        100% {
            background-position: -120% 0;
        }
    }

    .masonry-item img {
        width: 100%;
        height: auto;
        display: block;
        transition: transform .35s ease, opacity .35s ease;
        opacity: 0; /* resim yüklenene kadar görünmesin */
        position: relative;
        z-index: 0;
    }

    .masonry-item.is-loaded img {
        opacity: 1;
    }

    .masonry-item:hover {
        transform: translate3d(0,-5px,0) scale(1.01);
        box-shadow: 0 10px 28px rgba(0,0,0,0.18);
        border-color: rgba(0,0,0,0.12);
    }

        .masonry-item:hover img {
            transform: scale(1.05);
        }

    /* Sheen (kurumsal hafif ışık) */
    .masonry-item::after {
        content: "";
        position: absolute;
        top: -40%;
        left: -60%;
        width: 60%;
        height: 180%;
        transform: rotate(18deg);
        background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.55) 50%, rgba(255,255,255,0) 100% );
        opacity: 0;
        transition: opacity .25s ease, left .65s ease;
        pointer-events: none;
        z-index: 2;
    }

    .masonry-item:hover::after {
        opacity: 0.5;
        left: 120%;
    }

    @@media (max-width: 992px) {
        .masonry-gallery {
            column-count: 3;
        }
    }

    @@media (max-width: 768px) {
        .masonry-gallery {
            column-count: 2;
        }
    }

    @@media (max-width: 480px) {
        .masonry-gallery {
            column-count: 1;
        }
    }

    /* ========================= */
    /*       CUSTOM LIGHTBOX      */
    /* ========================= */

    .saha-lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.86);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 18px;
    }

        .saha-lightbox.open {
            display: flex;
        }

    .saha-lb-stage {
        width: min(92vw, 1100px);
        height: 88vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

        .saha-lb-stage img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 14px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.35);
            user-select: none;
            -webkit-user-drag: none;
            background: #fff;
        }

    .saha-lb-btn {
        position: absolute;
        border: 1px solid rgba(255,255,255,0.18);
        width: 54px;
        height: 54px;
        border-radius: 999px;
        background: rgba(255,255,255,0.16);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        cursor: pointer;
        transition: background .18s ease, box-shadow .18s ease, opacity .18s ease;
        box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        padding: 0;
        outline: none;
        -webkit-tap-highlight-color: transparent;
    }

        .saha-lb-btn:hover {
            background: rgba(255,255,255,0.28);
            box-shadow: 0 14px 34px rgba(0,0,0,0.45);
        }

    .saha-lb-prev {
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
    }

    .saha-lb-next {
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
    }

    .saha-lb-close {
        right: 18px;
        top: 18px;
    }

    .saha-lb-prev:hover, .saha-lb-next:hover {
        transform: translateY(-50%);
    }

    .saha-lb-btn.is-hidden {
        display: none !important;
    }

    .saha-lb-prev::before, .saha-lb-next::before {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        border-top: 2px solid rgba(255,255,255,0.95);
        border-right: 2px solid rgba(255,255,255,0.95);
        left: 50%;
        top: 50%;
        transform-origin: center;
    }

    .saha-lb-prev::before {
        transform: translate(-45%, -50%) rotate(-135deg);
    }

    .saha-lb-next::before {
        transform: translate(-55%, -50%) rotate(45deg);
    }

    .saha-lb-close::before, .saha-lb-close::after {
        content: "";
        position: absolute;
        width: 22px;
        height: 2px;
        background: rgba(255,255,255,0.95);
        left: 50%;
        top: 50%;
        transform-origin: center;
    }

    .saha-lb-close::before {
        transform: translate(-50%, -50%) rotate(45deg);
    }

    .saha-lb-close::after {
        transform: translate(-50%, -50%) rotate(-45deg);
    }

    @@media (max-width: 576px) {
        .saha-lb-btn {
            width: 46px;
            height: 46px;
        }

        .saha-lb-prev {
            left: 12px;
        }

        .saha-lb-next {
            right: 12px;
        }

        .saha-lb-close {
            right: 12px;
            top: 12px;
        }
    }

    /* Reduce motion */
    @@media (prefers-reduced-motion: reduce) {
        .masonry-item {
            opacity: 1;
            transform: none;
            filter: none;
            transition: none;
        }

            .masonry-item::before {
                display: none;
            }

            .masonry-item::after {
                display: none;
            }

            .masonry-item img {
                opacity: 1;
                transition: none;
            }
    }
</style>

<script>
    (function () {
      const gallery = document.getElementById("masonryGallery");
      const overlay = document.getElementById("sahaLightbox");
      const img = document.getElementById("sahaLbImg");
      const btnPrev = document.getElementById("sahaLbPrev");
      const btnNext = document.getElementById("sahaLbNext");
      const btnClose = document.getElementById("sahaLbClose");

      if (!gallery || !overlay || !img || !btnPrev || !btnNext || !btnClose) return;

      const items = Array.from(gallery.querySelectorAll("a.masonry-item"));
      const total = items.length;

      // --- A) STAGGER (masonry'de sıra gibi hissettirmek için) ---
      items.forEach((a, i) => {
        const delay = Math.min(i * 22, 800);
        a.style.setProperty("--d", delay + "ms");
      });

      // --- B) Resim load durumunu yönet (skeleton kaldırma) ---
      function markLoaded(a) {
        a.classList.add("is-loaded");
        const im = a.querySelector("img");
        if (im) im.style.opacity = "1";
      }

      // --- C) PREFETCH / EARLY LOAD: ekrana gelmeden önce yüklemeyi başlat ---
      // 1) data-src kullanmıyorsun, src zaten var.
      //    Biz sadece tarayıcıya "bu lazım olacak" diye erkenden download ettireceğiz.
      const requested = new WeakSet();

      function prefetchImage(a) {
        if (requested.has(a)) return;
        requested.add(a);

        const im = a.querySelector("img");
        if (!im) return;

        // Eğer zaten yüklüyse işaretle
        if (im.complete && im.naturalWidth > 0) {
          markLoaded(a);
          return;
        }

        // Lazy-loading agresif olabilir: decode öncesi fetch'i erkene çekmek için
        // yeni bir Image nesnesi ile istek başlatıyoruz.
        const src = im.currentSrc || im.src;
        if (!src) return;

        const warm = new Image();
        warm.decoding = "async";
        // Tarayıcı destekliyorsa öncelik ver
        try { warm.fetchPriority = "high"; } catch(e) {}
        warm.src = src;

        warm.onload = () => {
          // Ana img zaten aynı src'ye sahip; network cache'e girdi.
          // Ana img yüklenince skeleton kalksın:
          if (!im._hooked) {
            im._hooked = true;
            im.addEventListener("load", () => markLoaded(a), { once: true });
            im.addEventListener("error", () => markLoaded(a), { once: true });
          }
        };
        warm.onerror = () => {
          // hata olsa bile skeleton'ı kaldır (kart boş kalmasın)
          markLoaded(a);
        };

        // Ana img load event'i hiç bağlanmadıysa bağlayalım
        if (!im._hooked) {
          im._hooked = true;
          im.addEventListener("load", () => markLoaded(a), { once: true });
          im.addEventListener("error", () => markLoaded(a), { once: true });
        }
      }

      // Başlangıçta ilk ekranda görünenleri hemen prefetch et
      items.slice(0, 14).forEach(prefetchImage);

      // 1) Görsel yükleme IO: ekrana gelmeden önce (1200px) prefetch başlat
      const ioPrefetch = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            prefetchImage(entry.target);
          }
        });
      }, {
        threshold: 0,
        rootMargin: "1200px 0px 1200px 0px"
      });

      items.forEach(a => ioPrefetch.observe(a));

      // 2) Görünürlük/animasyon IO: çok az görünse bile animasyon başlasın, çıkınca geri gizlensin
      const ioVisible = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
          } else {
            entry.target.classList.remove("is-visible");
          }
        });
      }, {
        threshold: 0,
        rootMargin: "140px 0px 140px 0px"
      });

      items.forEach(a => ioVisible.observe(a));

      // 3) Network yoğunken scroll hızlıysa: yakın çevrede birkaç taneyi daha prefetch et (buffer)
      //    Bu, hızlı kaydırmada bir anda sıradaki 8-10 görselin gecikmesini azaltır.
      function prefetchNeighborhood(index) {
        const start = Math.max(0, index - 4);
        const end = Math.min(total - 1, index + 10);
        for (let i = start; i <= end; i++) prefetchImage(items[i]);
      }

      gallery.addEventListener("scroll", () => {}, { passive: true });

      // --- LIGHTBOX (senin kodun) ---
      let currentIndex = 0; // 0-based
      let lastScrollY = 0;

      function updateNavButtons() {
        btnPrev.classList.toggle("is-hidden", currentIndex <= 0);
        btnNext.classList.toggle("is-hidden", currentIndex >= total - 1);
      }

      function setImageByIndex(idx) {
        if (idx < 0) idx = 0;
        if (idx > total - 1) idx = total - 1;

        currentIndex = idx;

        // Lightbox açmadan önce komşuları da ısıt (ileri/geri hızlı geçişte de akıcı)
        prefetchNeighborhood(currentIndex);

        const href = items[currentIndex].getAttribute("href");
        img.src = href;

        updateNavButtons();
      }

      function openLightbox(idx) {
        lastScrollY = window.scrollY || 0;

        setImageByIndex(idx);

        overlay.classList.add("open");
        overlay.setAttribute("aria-hidden", "false");

        document.body.style.position = "fixed";
        document.body.style.top = `-${lastScrollY}px`;
        document.body.style.left = "0";
        document.body.style.right = "0";
        document.body.style.width = "100%";
      }

      function closeLightbox() {
        overlay.classList.remove("open");
        overlay.setAttribute("aria-hidden", "true");

        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";

        window.scrollTo(0, lastScrollY);
        img.src = "";
      }

      function next() { if (currentIndex < total - 1) setImageByIndex(currentIndex + 1); }
      function prev() { if (currentIndex > 0) setImageByIndex(currentIndex - 1); }

      gallery.addEventListener("click", function (e) {
        const a = e.target.closest("a.masonry-item");
        if (!a) return;

        e.preventDefault();

        const idx1based = parseInt(a.getAttribute("data-index"), 10);
        const idx0 = isNaN(idx1based) ? 0 : (idx1based - 1);

        // tıklanan ve çevresini hemen prefetch et
        prefetchNeighborhood(idx0);

        openLightbox(idx0);
      });

      btnNext.addEventListener("click", function (e) { e.stopPropagation(); next(); });
      btnPrev.addEventListener("click", function (e) { e.stopPropagation(); prev(); });
      btnClose.addEventListener("click", function (e) { e.stopPropagation(); closeLightbox(); });

      overlay.addEventListener("click", function (e) {
        if (e.target === img) return;
        closeLightbox();
      });

      document.addEventListener("keydown", function (e) {
        if (!overlay.classList.contains("open")) return;

        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowRight") next();
        if (e.key === "ArrowLeft") prev();
      });
    })();
</script>

